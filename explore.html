<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Jesmont Marketplace - Explore</title>
  <!-- Tailwind CSS CDN for quick styling -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.17.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.17.2/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.17.2/firebase-auth-compat.js"></script>
</head>
<body class="bg-gray-50 text-gray-800 min-h-screen flex flex-col">

  <header class="bg-black text-white p-4 sticky top-0 z-30 shadow-md">
    <div class="container mx-auto flex flex-col md:flex-row items-center justify-between gap-3">
      <h1 class="text-3xl font-bold">Jesmont Marketplace</h1>

      <div class="flex flex-col md:flex-row items-center gap-3 w-full md:w-auto">
        <input
          id="searchInput"
          type="text"
          placeholder="Search sellers or products..."
          class="flex-grow rounded px-3 py-2 text-black"
        />
        <select id="categoryFilter" class="rounded px-3 py-2 text-black">
          <option value="All">All Categories</option>
          <!-- Categories loaded dynamically -->
        </select>
      </div>
    </div>
  </header>

  <main class="container mx-auto flex flex-col md:flex-row gap-8 py-8 flex-grow">

    <!-- Sellers List -->
    <section class="md:w-1/3 bg-white rounded-lg shadow p-4 max-h-[80vh] overflow-y-auto">
      <h2 class="text-xl font-semibold mb-4">Sellers</h2>
      <div id="sellerList" class="space-y-4">
        <!-- Seller cards go here -->
      </div>
    </section>

    <!-- Products List -->
    <section class="md:w-2/3 bg-white rounded-lg shadow p-4 max-h-[80vh] overflow-y-auto">
      <h2 class="text-xl font-semibold mb-4">Products</h2>
      <div id="productList" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
        <!-- Product cards go here -->
      </div>
    </section>

  </main>

  <footer class="bg-black text-white text-center p-4">
    &copy; 2025 Jesmont Marketplace
  </footer>

  <script>
    // Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyDlakKgMzhADOywIOg4iTCJ5sUFXLMGwVg",
      authDomain: "jesmont-marketplace.firebaseapp.com",
      projectId: "jesmont-marketplace",
      storageBucket: "jesmont-marketplace.firebasestorage.app",
      messagingSenderId: "543717950238",
      appId: "1:543717950238:web:df009d49e88a2ea010bf0f",
      measurementId: "G-56TMB41PS8"
    };

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // DOM Elements
    const sellerList = document.getElementById('sellerList');
    const productList = document.getElementById('productList');
    const searchInput = document.getElementById('searchInput');
    const categoryFilter = document.getElementById('categoryFilter');

    // Data arrays
    let sellers = [];
    let products = [];
    let categoriesSet = new Set();

    // Fetch sellers from Firestore
    async function fetchSellers() {
      const snapshot = await db.collection('sellers').get();
      sellers = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
      extractCategoriesFromSellers();
      renderSellerList();
      populateCategoryFilter();
    }

    // Fetch products from Firestore
    async function fetchProducts() {
      const snapshot = await db.collection('products').get();
      products = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
      extractCategoriesFromProducts();
      renderProductList();
      populateCategoryFilter();
    }

    // Extract categories from sellers and products
    function extractCategoriesFromSellers() {
      sellers.forEach(seller => {
        if (seller.category) categoriesSet.add(seller.category);
      });
    }
    function extractCategoriesFromProducts() {
      products.forEach(product => {
        if (product.category) categoriesSet.add(product.category);
      });
    }

    // Populate category filter dropdown
    function populateCategoryFilter() {
      // Clear all except "All"
      const options = Array.from(categoryFilter.options);
      options.forEach((opt, i) => {
        if (opt.value !== 'All') categoryFilter.remove(i);
      });

      Array.from(categoriesSet)
        .sort()
        .forEach(cat => {
          const option = document.createElement('option');
          option.value = cat;
          option.textContent = cat;
          categoryFilter.appendChild(option);
        });
    }

    // Render seller cards based on current filter & search
    function renderSellerList() {
      const searchTerm = searchInput.value.toLowerCase();
      const category = categoryFilter.value;

      sellerList.innerHTML = '';

      const filteredSellers = sellers.filter(seller => {
        const matchesSearch =
          seller.name.toLowerCase().includes(searchTerm) ||
          (seller.description && seller.description.toLowerCase().includes(searchTerm));
        const matchesCategory = category === 'All' || seller.category === category;
        return matchesSearch && matchesCategory;
      });

      if (filteredSellers.length === 0) {
        sellerList.innerHTML = '<p class="text-gray-500">No sellers found.</p>';
        return;
      }

      filteredSellers.forEach(seller => {
        const sellerCard = document.createElement('div');
        sellerCard.className = 'border rounded p-3 flex flex-col items-center text-center shadow hover:shadow-lg transition cursor-pointer';

        sellerCard.innerHTML = `
          <img src="${seller.logo || 'https://via.placeholder.com/100?text=Logo'}" alt="${seller.name} Logo" class="w-24 h-24 object-contain rounded-full mb-3" />
          <h3 class="text-lg font-semibold">${seller.name}</h3>
          <p class="text-sm text-gray-600 mb-2">${seller.category || 'No Category'}</p>
          <p class="text-sm mb-4 line-clamp-3">${seller.description || ''}</p>
          <button
            class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-1 rounded"
            onclick="viewSellerProfile('${seller.id}')"
          >
            View Profile
          </button>
        `;

        sellerList.appendChild(sellerCard);
      });
    }

    // Render product cards based on current filter & search
    function renderProductList() {
      const searchTerm = searchInput.value.toLowerCase();
      const category = categoryFilter.value;

      productList.innerHTML = '';

      const filteredProducts = products.filter(product => {
        const matchesSearch =
          product.name.toLowerCase().includes(searchTerm) ||
          (product.description && product.description.toLowerCase().includes(searchTerm));
        const matchesCategory = category === 'All' || product.category === category;
        return matchesSearch && matchesCategory;
      });

      if (filteredProducts.length === 0) {
        productList.innerHTML = '<p class="text-gray-500 col-span-full text-center">No products found.</p>';
        return;
      }

      filteredProducts.forEach(product => {
        // Find seller info for product
        const seller = sellers.find(s => s.id === product.sellerId);

        const productCard = document.createElement('div');
        productCard.className = 'border rounded-lg shadow hover:shadow-lg transition overflow-hidden flex flex-col';

        productCard.innerHTML = `
          <img src="${product.imageUrl || 'https://via.placeholder.com/300x200?text=No+Image'}" alt="${product.name}" class="w-full h-48 object-cover" />
          <div class="p-4 flex flex-col flex-grow">
            <h3 class="font-semibold text-lg mb-1">${product.name}</h3>
            <p class="text-gray-600 text-sm flex-grow mb-2 line-clamp-3">${product.description || ''}</p>
            <p class="font-bold text-blue-600 mb-2">Ksh ${product.price?.toFixed(2) || 'N/A'}</p>
            ${seller ? `
              <div class="mt-auto pt-2 border-t flex items-center gap-3">
                <img src="${seller.logo || 'https://via.placeholder.com/40'}" alt="${seller.name}" class="w-10 h-10 rounded-full object-contain" />
                <div>
                  <p class="text-sm font-semibold">${seller.name}</p>
                  <p class="text-xs text-gray-500">${seller.category || ''}</p>
                </div>
              </div>
            ` : ''}
          </div>
        `;

        productList.appendChild(productCard);
      });
    }

    // Search input & category filter events
    searchInput.addEventListener('input', () => {
      renderSellerList();
      renderProductList();
    });

    categoryFilter.addEventListener('change', () => {
      renderSellerList();
      renderProductList();
    });

    // View seller profile (placeholder, will navigate later)
    function viewSellerProfile(sellerId) {
      // For now, just alert or console log, replace with actual page link later
      // E.g. window.location.href = `seller-profile.html?id=${sellerId}`;
      alert(`View profile for seller ID: ${sellerId}`);
    }

    // Initialize page by fetching data
    async function init() {
      await Promise.all([fetchSellers(), fetchProducts()]);
      renderSellerList();
      renderProductList();
    }

    init();
  </script>

  <style>
    /* Tailwind line-clamp fallback for limited lines */
    .line-clamp-3 {
      overflow: hidden;
      display: -webkit-box;
      -webkit-line-clamp: 3;
      -webkit-box-orient: vertical;
    }
  </style>
</body>
</html>
