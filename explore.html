<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
  import { getFirestore, collection, getDocs, query, where } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyDlakKgMzhADOywIOg4iTCJ5sUFXLMGwVg",
    authDomain: "jesmont-marketplace.firebaseapp.com",
    projectId: "jesmont-marketplace",
    storageBucket: "jesmont-marketplace.appspot.com",
    messagingSenderId: "543717950238",
    appId: "1:543717950238:web:df009d49e88a2ea010bf0f",
    measurementId: "G-56TMB41PS8"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  let allSellers = [];
  let allProducts = [];
  let selectedCategory = "all";
  let selectedSellerUid = null;

  async function loadSellers() {
    const sellerProfiles = document.getElementById("sellerProfiles");
    sellerProfiles.innerHTML = "Loading sellers...";

    try {
      const snapshot = await getDocs(collection(db, "sellers"));
      allSellers = snapshot.docs.map(doc => {
        const data = doc.data();
        return {
          id: doc.id,
          uid: data.uid,
          businessName: data.businessName,
          category: (data.category || "uncategorized").toLowerCase(),
          logoURL: data.logoURL || "",
          description: data.businessDescription || data.description || "",
        };
      });

      if (allSellers.length === 0) {
        sellerProfiles.innerHTML = "<p class='text-gray-500'>No sellers found.</p>";
        return;
      }

      displaySellerProfiles(allSellers);
      selectSeller(allSellers[0].uid);

    } catch (error) {
      console.error("Error loading sellers:", error);
      sellerProfiles.innerHTML = "<p class='text-red-500'>Failed to load sellers.</p>";
    }
  }

  function displaySellerProfiles(sellers) {
    const sellerProfiles = document.getElementById("sellerProfiles");
    sellerProfiles.innerHTML = "";

    sellers.forEach(seller => {
      const card = document.createElement("div");
      card.className = "seller-profile";
      card.dataset.uid = seller.uid;
      card.dataset.category = seller.category;

      const img = document.createElement("img");
      img.src = seller.logoURL || "https://via.placeholder.com/70?text=Logo";
      img.alt = `${seller.businessName} Logo`;
      img.onerror = () => {
        img.src = "https://via.placeholder.com/70?text=Logo";
      };

      card.appendChild(img);

      const name = document.createElement("div");
      name.className = "font-semibold text-sm truncate";
      name.title = seller.businessName;
      name.textContent = seller.businessName;
      card.appendChild(name);

      const cat = document.createElement("div");
      cat.className = "text-xs text-gray-500 truncate";
      cat.title = seller.category;
      cat.textContent = capitalize(seller.category);
      card.appendChild(cat);

      card.addEventListener("click", () => selectSeller(seller.uid));
      sellerProfiles.appendChild(card);
    });
  }

  async function loadProductsForSeller(sellerUid) {
    const productListings = document.getElementById("productListings");
    productListings.innerHTML = "Loading products...";

    try {
      const q = query(collection(db, "products"), where("sellerUid", "==", sellerUid));
      const snapshot = await getDocs(q);
      allProducts = snapshot.docs.map(doc => {
        const data = doc.data();
        return {
          id: doc.id,
          productName: data.productName,
          productDescription: data.productDescription || "",
          price: data.price || "",
          productImageURL: data.productImageURL || "",
        };
      });

      displayProducts(allProducts);

    } catch (error) {
      console.error("Error loading products:", error);
      productListings.innerHTML = "<p class='text-red-500'>Failed to load products.</p>";
    }
  }

  function displayProducts(products) {
    const productListings = document.getElementById("productListings");
    productListings.innerHTML = "";

    if (products.length === 0) {
      productListings.innerHTML = "<p class='text-gray-500'>No products found for this seller.</p>";
      return;
    }

    products.forEach(product => {
      const card = document.createElement("div");
      card.className = "product-card";

      const img = document.createElement("img");
      img.src = product.productImageURL || "https://via.placeholder.com/300x200?text=No+Image";
      img.alt = product.productName;
      img.onerror = () => {
        img.src = "https://via.placeholder.com/300x200?text=No+Image";
      };
      card.appendChild(img);

      const name = document.createElement("h3");
      name.className = "text-lg font-semibold";
      name.textContent = product.productName;
      card.appendChild(name);

      const desc = document.createElement("p");
      desc.className = "text-gray-700 text-sm mb-2";
      desc.textContent = product.productDescription;
      card.appendChild(desc);

      const price = document.createElement("p");
      price.className = "text-green-600 font-bold";
      price.textContent = product.price ? "KES " + product.price : "Price not set";
      card.appendChild(price);

      productListings.appendChild(card);
    });
  }

  function selectSeller(uid) {
    selectedSellerUid = uid;

    const sellerCards = document.querySelectorAll(".seller-profile");
    sellerCards.forEach(card => {
      card.classList.toggle("selected", card.dataset.uid === uid);
    });

    loadProductsForSeller(uid);
  }

  function filterSellers() {
    const searchValue = document.getElementById("searchBar").value.toLowerCase();

    const filteredSellers = allSellers.filter(seller => {
      const matchesCategory = selectedCategory === "all" || seller.category === selectedCategory;
      const matchesSearch =
        seller.businessName.toLowerCase().includes(searchValue) ||
        seller.description.toLowerCase().includes(searchValue);
      return matchesCategory && matchesSearch;
    });

    displaySellerProfiles(filteredSellers);

    if (!filteredSellers.some(s => s.uid === selectedSellerUid)) {
      if (filteredSellers.length > 0) {
        selectSeller(filteredSellers[0].uid);
      } else {
        document.getElementById("productListings").innerHTML = "<p class='text-gray-500'>No sellers match your filter.</p>";
        selectedSellerUid = null;
      }
    }
  }

  function capitalize(str) {
    return str.charAt(0).toUpperCase() + str.slice(1);
  }

  function setupFilters() {
    const searchBar = document.getElementById("searchBar");
    searchBar.addEventListener("input", filterSellers);

    const categoryButtons = document.querySelectorAll(".category-btn");
    categoryButtons.forEach(btn => {
      btn.addEventListener("click", () => {
        selectedCategory = btn.dataset.category.toLowerCase();

        categoryButtons.forEach(b => b.classList.remove("selected"));
        btn.classList.add("selected");

        filterSellers();
      });
    });
  }

  document.addEventListener("DOMContentLoaded", () => {
    loadSellers();
    setupFilters();
  });
</script>
